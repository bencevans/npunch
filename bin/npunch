#!/usr/bin/env node

var program = require('commander'),
tabtabCommander = require('tabtab-commander'),
nodepunch = require('../lib/npunch.js'),
path = require('path'),
fs = require('fs');


// Backwards Compatibility.
fs.existsSync || (fs.existsSync = path.existsSync);


// Check Supported Operating System

if(process.platform !== 'darwin') {
    console.error('n(ode)Punch only supports Darwin/MacOSX due to support from dependencies (Pow).');
    process.exit();
}

// Check required paths exist.

if(!fs.existsSync(nodepunch.powPath)) {
    console.error('Pow doesn\'t appear to be installed to the usual location if at all.');
    process.exit();
}

// Program...

program
    .version(nodepunch.version())

program
    .command('ln <dir>')
    .description('link/add project')
    .action(function(dir){

        //TODO: 'npunch ln .' should work.
        //TODO: 'npunch ln ./afolderthatexists' should work.
        //TODO: 'npunch ln /absoulte/folder/path/that/exists' should work
        //TODO: 'npunch ln ./a/folder/that/doesnt/exist' should fail

        try {
            nodepunch.link(process.cwd());
        } catch(err) {

            if(err.errno == 47)
                console.warn("There's already a project with this name.");
            else
                console.warn('Unknown Error: ' + err);
        }
    });

program
    .command('rm <projectIdentifier>')
    .description('link/add project')
    .action(function (projectIdentifier){

        var projectName = nodepunch.findProjectName(projectIdentifier);

        if(!projectName) {
            throw Error("No Project Found")
        }


        // Check the project exists
        if(self.exists(projectName) == false) {
            throw Error("No Project Found")
        }

        //TODO: Check and turn off if running before unlink

        // Go forth and unlink
        var unlinkResult = fs.unlinkSync(self.nodepunchPath + '/' + projectName);

        if(typeof unlinkResult == 'undefined')
            return true
        else
            return unlinkResult


    });

program
    .command('ls')
    .description('list added projects')
    .action(function(){

        //TODO: Put Output into a pretty table.

        console.log(nodepunch.list());
    });

program
    .command('start <projectIdentifier>')
    .description('start a project')
    .action(function (projectIdentifier){

        var projectName = nodepunch.findProjectName(projectIdentifier);

        if(!projectName) {
            throw Error("No Project Found")
        }

        nodepunch.start(projectName);
    });

program
    .command('stop <projectIdentifier>')
    .description('stop a project')
    .action(function (projectIdentifier){

        var projectName = nodepunch.findProjectName(projectIdentifier);

        if(!projectName) {
            throw Error("No Project Found")
        }

        fs.unlinkSync(nodepunchPath + '/' + process.argv[3] );
    });

program
    .command('open <projectIdentifier>')
    .description('open the project in browser')
    .action(function (projectIdentifier){

        var projectName = nodepunch.findProjectName(projectIdentifier);

        if(!projectName) {
            throw Error("No Project Found")
        }


        // Project name given
        if(typeof process.argv[3] !== 'undefined') {
            var projectInfo = nodepunch.projectInfo(process.argv[3]);
            if(projectInfo && projectInfo.status == 'on')
                util.exec('open http://' + projectInfo.name + '.dev')
            else
                console.log("Projects Status must be 'on', It's currently '" + projectInfo.status + "'");
        } else {
            //Try and work out project name from cwd

        }

    });

tabtabCommander.init(program, 'npunch');

program.parse(process.argv);

